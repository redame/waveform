<!--
CUSTOM ELEMENT: floating-info
BY: DM


TODO:  don't let the info go offscreen - knock it back in if need be.
TODO: need to fire event when closed so that temporary panes can be removed from DOM when closed.

By default it is hidden. To show/close the info use the .show/.close/.toggle methods.  You *must* supply and index argument to these methods,
which will be used to change the show/close value wihtin an array.  If any elements in the array are set to true the info will be shown.  The reason for this
is that there may be several competing things trying to show/hide the info and this system should allow them each a "voice".

When closemode="true", mouseover the info will show a red cover pane, which you can click to close the info...this will reset the show/close array to be fully closed.

USEAGE:
	<floating-info closemode="false">
		<floating-info-title>
			This is my title.
		</floating-info-title>
		everything else is in my body.
		<div nodrag>
			mouse down here will not cause the element to start dragging, but mousedown anywhere else will...that's because of the nodrag attribute used.
		</div>
	</floating-info>
	
	
-->
<link rel="import" href="polymer/polymer.html">

<polymer-element name='floating-info-title' noscript><content></content></polymer-element>

<polymer-element name="floating-info" attributes='closemode'> 
<template>
    <style>
	:host{
	position: fixed;
	min-width: 200px;
	max-width: 400px;
	background-color: rgba(255,255,255,0.8);
	will-change: transform;
	display:none;
	z-index:100;
	cursor: move;
	box-shadow: 3px 3px 7px #999;
	top: 100px;
	left: 400px;
	}
	.cover{
	position: absolute;
	left:0px; 
	top:0px;
	display: none;
	width: 100%;
	height: 100%;
	border: 3px solid #F00;
	box-sizing:border-box;-moz-box-sizing:border-box;
	background: rgba(255,200,200,0.5);
	cursor:pointer !important;
	}
	:host(:hover) .cover{
	display: block;
	}
	.f-title{
	background:#333;
	color: #fff;
	font-weight:bold;
	display: block;
	padding:5px;
	}
	.f-body{
	border: 1px solid #000;
	min-height: 60px;
	padding: 8px;
	}
	</style>
	
	<div class='f-title'><content select='floating-info-title'></content></div>
	<div class='f-body'><content></content></div>
	<div class='cover' style="{{ closemode ? '' : 'display:none'}}" on-click="{{_coverClick}}"></div>
</template>
<script>

	var topZIndex = 100; //global
	
	var Translate = function(el,x,y){	
		var str = x==null ? "" : "translate(" + x + "px," + y + "px)";
		el.style.webkitTransform = str; //TODO: cross-bowser support
	}
	
	var Document_MouseMove = function(e){
		e.stopPropagation();
		Translate(this,e.clientX + this._handLeft, e.clientY + this._handTop);
	}
	
	var Document_MouseUp = function(e){
		document.body.style.cursor = '';
		document.removeEventListener('mousemove',this._Document_MouseMove,true);
		document.removeEventListener('mouseup',this._Document_MouseUp,true);
		this.style.left = e.clientX + this._handLeft + 'px';
		this.style.top = e.clientY + this._handTop + 'px';
		Translate(this,null);
		
	}
	
	var Floating_MouseDown = function(event){
		if(this.closeMode)
			return; //let the cover deal with the mouse in closemode
			
		// if the mouse-down element or any of its ancestors has the "nodrag" attribute then dont start the dragging.
		for(var i=0;event.path[i] != this;i++) if(event.path[i].hasAttribute && event.path[i].hasAttribute('nodrag'))
				return;
				
		this.style.zIndex = ++topZIndex; //bring this floating info to the front (of other floating info within the same parent)
		this._handLeft = this.offsetLeft -event.clientX; //strictly speaking I think this isn't going to work if there is any scrolling involved
		this._handTop = this.offsetTop -event.clientY;
		
		this.style.top = '0px';
		this.style.left = '0px';
		document.body.style.cursor = 'move';
		
		//this seems a bit clumsy...but how else can we do it if we want to keep a reference to the bound version so we can remove it later?
		this._Document_MouseMove = Document_MouseMove.bind(this); 
		this._Document_MouseUp = Document_MouseUp.bind(this);
		document.addEventListener('mousemove',this._Document_MouseMove,true);
		document.addEventListener('mouseup',this._Document_MouseUp,true);
		//TODO: check that we can swallow all the pointer events at the document level while dragging..don't want anything else to get any pointer events.
		
		return this._Document_MouseMove(event);
	}
	
	var any = function(arr){
		for(var i=0;i<arr.length;i++)if(arr[i])
			return true;
		return false;
	}
	
	Polymer('floating-info',{
		_handLeft: 0,  _handTop: 0, //these two properties store the position of the cursor within the pane at the start of a drag
		_show: [], //if any elements in this array are true we show, otherwise we leave the info hidden
		get isOpen(){
				return any(this._show);
			},
		toggle: function(ind){
			 this._show[ind] = !this._show[ind];
			  this.style.display = any(this._show) ? 'block' : '' ;
			},
		show: function(ind){
			this._show[ind] = 1;
			this.style.display = any(this._show) ? 'block' : '' ;
			},
		close: function(ind){
			this._show[ind] = 0;
			this.style.display = any(this._show) ? 'block' : '' ;
			},
		ready: function(){
			this.addEventListener('mousedown',Floating_MouseDown.bind(this));
			this._show = [];
		},
		_coverClick: function(){
			this._show = [];
			this.style.display = '' ;
		}
	});
</script>
</polymer-element>